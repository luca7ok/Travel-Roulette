@page "/flight-test"
@using PoliHack18.Services
@using PoliHack18.Models
@using PoliHack18.Constants
@inject IFlightService FlightService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">Trip Roulette</MudText>
    <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="mb-4">
    </MudText>

    <MudPaper Class="pa-6" Elevation="3">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect T="string"
                           Label="Origin Airport"
                           @bind-Value="_origin"
                           Variant="Variant.Outlined"
                           AdornmentIcon="@Icons.Material.Filled.FlightTakeoff"
                           Error="@_hasOriginError"
                           ErrorText="@_originErrorMessage"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var airport in _airportOptions)
                    {
                        <MudSelectItem Value="@airport.Code">@airport.DisplayName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="_departureDate"
                               Label="Departure Date"
                               Variant="Variant.Outlined"
                               MinDate="@DateTime.Today"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Filled.DateRange"/>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="_returnDate"
                               Label="Return Date"
                               Variant="Variant.Outlined"
                               MinDate="@(_departureDate ?? DateTime.Today)"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Filled.DateRange"/>
            </MudItem>

            <MudItem xs="12">
                <MudNumericField @bind-Value="_maxPrice"
                                 Label="Total Budget (Flights + Hotel)"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Euro"
                                 HelperText="@GetBudgetPerPersonText()"/>
            </MudItem>

            <MudItem xs="12">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="FindRandomFlight"
                           Disabled="@_isLoading"
                           Size="Size.Large"
                           Class="py-3">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                        <MudText>Finding flights & hotels...</MudText>
                    }
                    else
                    {
                        <MudText>Find My Trip!</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_selectedTrip != null)
    {
        <MudCard Class="mt-6 animate-fade-in" Elevation="4">
            <MudCardHeader>
                <CardHeaderAvatar>
                    <MudAvatar Color="Color.Primary" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.LocationCity"/>
                    </MudAvatar>
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">Trip to @_selectedTrip.Destination</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Full Package Found!</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            
            <MudCardContent>
                <MudGrid Class="mb-4">
                    <MudItem xs="12" sm="6">
                        <MudPaper Class="pa-3" Elevation="0" Outlined="true">
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Flight" Color="Color.Info" Size="Size.Large"/>
                                <div>
                                    <MudText Typo="Typo.subtitle1"><b>Flight</b></MudText>
                                    <MudText Typo="Typo.body2">@_selectedTrip.FlightInfo</MudText>
                                </div>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudPaper Class="pa-3" Elevation="0" Outlined="true">
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Hotel" Color="Color.Warning" Size="Size.Large"/>
                                <div>
                                    <MudText Typo="Typo.subtitle1"><b>Accommodation</b></MudText>
                                    @if (!string.IsNullOrEmpty(_selectedTrip.HotelInfo))
                                    {
                                        <MudText Typo="Typo.body2">@_selectedTrip.HotelInfo</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Error">No hotel found within remaining budget.</MudText>
                                    }
                                </div>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4"/>

                <MudGrid Justify="Justify.SpaceAround">
                    <MudItem xs="6" Class="text-center">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Package Per Person</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Primary">
                            €@_selectedTrip.PricePerPerson.ToString("F2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" Class="text-center">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Trip Cost</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Success">
                            <b>€@_selectedTrip.TotalPrice.ToString("F2")</b>
                        </MudText>
                    </MudItem>
                </MudGrid>

                @if (_numberOfPeople > 1)
                {
                    <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary" Class="mt-2">
                        Includes Flight + Hotel for @_numberOfPeople travelers
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    }
    else if (_hasSearched && !_isLoading)
    {
        <MudAlert Severity="Severity.Warning" Class="mt-4" Variant="Variant.Filled">
            <MudText Typo="Typo.body1"><strong>No complete trips found!</strong></MudText>
            <MudText Typo="Typo.body2" Class="mt-1">
               @Class1.s
            </MudText>
        </MudAlert>
    }
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .text-center {
        text-align: center;
    }
</style>

@code {
    private string _origin = "CLJ";
    private int _numberOfPeople = 1;
    private decimal _maxPrice = 1500;
    private DateTime? _departureDate = DateTime.Today.AddDays(1); 
    private DateTime? _returnDate = DateTime.Today.AddDays(8);

    private TripOption? _selectedTrip;
    private bool _isLoading = false;
    private bool _hasSearched = false;
    private bool _hasOriginError = false;
    private string _originErrorMessage = "";

    private IEnumerable<AirportData.AirportInfo> _airportOptions = new List<AirportData.AirportInfo>();

    protected override void OnInitialized()
    {
        _airportOptions = AirportData.GetAllAirports();
    }

    private string GetBudgetPerPersonText()
    {
        if (_numberOfPeople <= 0) return "";
        var perPerson = _maxPrice / _numberOfPeople;
        return $"≈ €{perPerson:F2} per person (Flight + Hotel)";
    }

    private async Task FindRandomFlight()
    {
        if (_returnDate == null)
        {
            Snackbar.Add("Please select a return date to find a hotel.", Severity.Warning);
            return;
        }

        _isLoading = true;
        _hasSearched = true;
        _selectedTrip = null;
        _hasOriginError = false;

        try
        {
            var criteria = new TripSearchCriteria
            {
                Origin = _origin,
                MaxPrice = _maxPrice,
                NumberOfPeople = _numberOfPeople,
                DepartureDate = _departureDate ?? DateTime.Today,
                ReturnDate = _returnDate.Value
            };

            await Task.Run(async () => 
            { 
                _selectedTrip = await FlightService.GetRandomFlight(criteria); 
            });

            if (_selectedTrip == null)
            {
                Snackbar.Add("Could not find a flight + hotel package within budget.", Severity.Warning);
            }
        }
        catch (ArgumentException ex) when (ex.Message.Contains("European airport"))
        {
            _hasOriginError = true;
            _originErrorMessage = "Only European airports are allowed";
            Snackbar.Add($"{ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}