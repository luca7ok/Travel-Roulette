@page "/flight-test"
@using PoliHack18.Services
@using PoliHack18.Models
@using PoliHack18.Constants
@inject IFlightService FlightService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">✈Flight Roulette</MudText>
    <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="mb-4">
        Discover your next adventure from Europe
    </MudText>

    <MudPaper Class="pa-6" Elevation="3">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect T="string"
                           Label="Origin Airport"
                           @bind-Value="_origin"
                           Variant="Variant.Outlined"
                           AdornmentIcon="@Icons.Material.Filled.FlightTakeoff"
                           Error="@_hasOriginError"
                           ErrorText="@_originErrorMessage"
                           AnchorOrigin="Origin.BottomCenter">

                    @foreach (var airport in _airportOptions)
                    {
                        <MudSelectItem Value="@airport.Code">@airport.DisplayName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudNumericField @bind-Value="_numberOfPeople"
                                 Label="Number of Travelers"
                                 Variant="Variant.Outlined"
                                 Min="1"
                                 Max="9"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.People"/>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="_departureDate"
                               Label="Departure Date"
                               Variant="Variant.Outlined"
                               MinDate="@DateTime.Today"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Filled.FlightTakeoff"/>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="_returnDate"
                               Label="Return Date"
                               Variant="Variant.Outlined"
                               MinDate="@(_departureDate ?? DateTime.Today)"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Filled.FlightLand"
                               Clearable="true"
                               HelperText="Leave empty for one-way"/>
            </MudItem>

            <MudItem xs="12">
                <MudNumericField @bind-Value="_maxPrice"
                                 Label="Total Budget (All Travelers)"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Euro"
                                 HelperText="@GetBudgetPerPersonText()"/>
            </MudItem>

            <MudItem xs="12">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="FindRandomFlight"
                           Disabled="@_isLoading"
                           Size="Size.Large"
                           Class="py-3">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                        <MudText>Searching for flights...</MudText>
                    }
                    else
                    {
                        <MudText>Surprise me!</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_selectedTrip != null)
    {
        <MudCard Class="mt-6 animate-fade-in" Elevation="4">
            <MudCardHeader>
                <CardHeaderAvatar>
                    <MudAvatar Color="Color.Secondary" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.AirplanemodeActive"/>
                    </MudAvatar>
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">Your Next Adventure!</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedTrip.FlightInfo</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardMedia
                Image="https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=800&auto=format&fit=crop"
                Height="250"/>
            <MudCardContent>
                <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Primary" Class="mb-2">
                    @_selectedTrip.Destination
                </MudText>
                @if (!string.IsNullOrEmpty(_selectedTrip.DestinationCode))
                {
                    <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary" Class="mb-3">
                        Airport: @_selectedTrip.Destination (@_selectedTrip.DestinationCode)
                    </MudText>
                }
                <MudDivider Class="my-4"/>
                <MudGrid Justify="Justify.SpaceAround">
                    <MudItem xs="6" Class="text-center">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Per Person</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Primary">
                            €@_selectedTrip.PricePerPerson.ToString("F2")</MudText>
                    </MudItem>
                    <MudItem xs="6" Class="text-center">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Price</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Primary">
                            €@_selectedTrip.TotalPrice.ToString("F2")</MudText>
                    </MudItem>
                </MudGrid>
                @if (_numberOfPeople > 1)
                {
                    <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary" Class="mt-2">
                        For @_numberOfPeople travelers
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    }
    else if (_hasSearched && !_isLoading)
    {
        <MudAlert Severity="Severity.Warning" Class="mt-4" Variant="Variant.Filled">
            <MudText Typo="Typo.body1"><strong>No flights found!</strong></MudText>
            <MudText Typo="Typo.body2" Class="mt-1">
                Try adjusting your budget, dates, or origin airport.
            </MudText>
        </MudAlert>
    }
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .text-center {
        text-align: center;
    }
</style>

@code {
    private string _origin = "MAD";
    private int _numberOfPeople = 1;
    private decimal _maxPrice = 1000;
    private DateTime? _departureDate = DateTime.Today.AddDays(1);
    private DateTime? _returnDate = DateTime.Today.AddDays(7);

    private TripOption? _selectedTrip;
    private bool _isLoading = false;
    private bool _hasSearched = false;
    private bool _hasOriginError = false;
    private string _originErrorMessage = "";

    private IEnumerable<AirportData.AirportInfo> _airportOptions = new List<AirportData.AirportInfo>();

    protected override void OnInitialized()
    {
        _airportOptions = AirportData.GetAllAirports();
    }

    private string GetBudgetPerPersonText()
    {
        if (_numberOfPeople <= 0) return "";
        var perPerson = _maxPrice / _numberOfPeople;
        return $"≈ €{perPerson:F2} per person";
    }

    private async Task FindRandomFlight()
    {
        _isLoading = true;
        _hasSearched = true;
        _selectedTrip = null;
        _hasOriginError = false;
        _originErrorMessage = "";

        try
        {
            var criteria = new TripSearchCriteria
            {
                Origin = _origin,
                MaxPrice = _maxPrice,
                NumberOfPeople = _numberOfPeople,
                DepartureDate = _departureDate ?? DateTime.Today,
                ReturnDate = _returnDate ?? DateTime.Today.AddDays(7)
            };

            await Task.Run(async () => { _selectedTrip = await FlightService.GetRandomFlight(criteria); });

            if (_selectedTrip == null)
            {
                Snackbar.Add("No flights found. Try different criteria.", Severity.Warning);
            }
            else
            {
                Snackbar.Add($"Found a flight to {_selectedTrip.Destination}!", Severity.Success);
            }
        }
        catch (ArgumentException ex) when (ex.Message.Contains("European airport"))
        {
            _hasOriginError = true;
            _originErrorMessage = "Only European airports are allowed";
            Snackbar.Add($"{ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

}