@page "/my-trips"
@using PoliHack18.Models
@using PoliHack18.Services;
@using PoliHack18.Repository
@inject NavigationManager NavManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-6"
             Style="font-size: 2.5rem; color: #ffffff; marinn-top:-20px">My Trips
    </MudText>

    @if (MySavedTrips == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
        <MudText Align="Align.Center" Style="color:white">Loading your trips...</MudText>
    }
    else if (MySavedTrips.Count == 0)
    {
        <MudPaper Class="pa-8 text-center mt-8" Elevation="0">
            <MudIcon Icon="@Icons.Material.Outlined.FlightTakeoff"
                     Size="Size.Large"
                     Color="Color.Default"
                     Class="mb-4"
                     Style="font-size: 64px; opacity: 0.3;"/>
            <MudText Typo="Typo.h6" Class="mb-2" Style="color:white">No trips yet</MudText>
            <MudText Color="Color.Default" Class="mb-4" Style="color:white">You haven't saved any trips yet.</MudText>
            <MudButton Variant="Variant.Filled"
                       Style="color:white" ,
                       StartIcon="@Icons.Material.Filled.Search"
                       OnClick="GoToSearch">
                Find a Trip Now
            </MudButton>
        </MudPaper>
    }
    else
    {
        <MudGrid>
            @{ int i = 0; }
            @foreach (var trip in MySavedTrips)
            {
                bool isUnlocked = (i != 0);
                i++;

                if (isUnlocked)
                {
                    <MudItem xs="12" sm="6" md="6">
                        <MudCard Elevation="4" Class="h-100">
                            <MudCardHeader Style="background-color: #743725; color: #ffffff">
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6" Style="color:#EFE2D2">@trip.Destination</MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudIconButton Icon="@Icons.Material.Filled.Flight"
                                                   Color="Color.Inherit"/>
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent Style="background-color: #EFE2D2; color: #27120F">
                                <MudText Typo="Typo.body1" Class="mb-2">
                                    <strong>Flight:</strong>@trip.FlightInfo
                                </MudText>
                                <MudText Typo="Typo.body1" Class="mb-4">
                                    <strong>Hotel:</strong> @trip.HotelInfo
                                </MudText>
                                <MudDivider Class="my-4"/>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Color="Color.Default">Total Price:</MudText>
                                    <MudText Typo="Typo.h5" Style="color: #27120F">â‚¬@trip.TotalPrice</MudText>
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12" sm="6" md="6">
                        <MudCard Elevation="2" Class="h-100" Style="opacity: 0.8; border: 2px dashed #743725;">
                            <MudCardHeader Style="background-color: #3e2b26; color: #ffffff">
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6" Style="color:#EFE2D2; font-style: italic;">
                                        @trip.Destination (Locked)
                                    </MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Warning"/>
                                </CardHeaderActions>
                            </MudCardHeader>

                            <MudCardContent
                                Style="background-color: #dccdbb; color: #27120F; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px;">
                                <MudIcon Icon="@Icons.Material.Filled.LockClock"
                                         Style="font-size: 4rem; color: #743725; opacity: 0.6;" Class="mb-3"/>

                                <MudText Typo="Typo.h6" Align="Align.Center">
                                    Surprise Awaits!
                                </MudText>

                                <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-2">
                                    Trip details are hidden until<br/>
                                    <strong>@GetUnlockDate(trip).ToString("MMM dd, HH:mm")</strong>
                                </MudText>

                                <MudTooltip Text="We keep the details secret until 24h before your flight!">
                                    <MudChip T="string" Color="Color.Dark" Variant="Variant.Text" Size="Size.Small"
                                             Icon="@Icons.Material.Filled.Info" Class="mt-4">
                                        Why is this locked?
                                    </MudChip>
                                </MudTooltip>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private List<TripOption>? MySavedTrips;

    private bool IsTripUnlocked(TripOption trip)
    {
        string departureDate = trip.FlightInfo.Split(" to ")[0];
        var hoursUntilDeparture = (DateTime.Parse(departureDate) - DateTime.Now).TotalHours;
        return hoursUntilDeparture <= 24;
    }


    private DateTime GetDepartureDate(TripOption trip)
    {
        try
        {
            string departureDateString = trip.FlightInfo.Split(" to ")[0];
            return DateTime.Parse(departureDateString);
        }
        catch (Exception ex)
        {
            return DateTime.MaxValue;
        }
    }

    private DateTime GetUnlockDate(TripOption trip)
    {
        return GetDepartureDate(trip).AddHours(-24);
    }

    protected override void OnInitialized()
    {
        if (UserSession.IsLoggedIn)
        {
            try
            {
                var repo = new TripRepository();
                MySavedTrips = repo.GetTripsByUser(UserSession.CurrentUserId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading trips: {ex.Message}");
                MySavedTrips = new List<TripOption>();
            }
        }
    }

    private void GoToSearch()
    {
        NavManager.NavigateTo("flight-test");
    }

}