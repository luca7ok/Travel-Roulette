@page "/my-trips"
@using PoliHack18.Models
@using PoliHack18.Repository
@inject NavigationManager NavManager
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6" Style="color: white">My Trips</MudText>
    <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="mb-4">
    </MudText>

    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
        <MudText Align="Align.Center" Style="color:white">Loading your trips...</MudText>
    }
    else if (loadError != null)
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">
            Failed to load trips: @loadError
            <MudButton OnClick="RetryLoad" Color="Color.Error" Variant="Variant.Text" Class="ml-2">Retry</MudButton>
        </MudAlert>
    }
    else if (MySavedTrips == null || MySavedTrips.Count == 0)
    {
        <MudPaper Class="pa-6 text-center mt-6" Elevation="0" Style="background-color:#EFE2D2; border-radius: 16px;">
            <MudIcon Icon="@Icons.Material.Outlined.FlightTakeoff"
                     Size="Size.Large"
                     Color="Color.Default"
                     Class="mb-3"
                     Style="font-size: 48px; opacity: 0.3; color:#27120F"/>
            <MudText Typo="Typo.h6" Class="mb-2" Style="color:#27120F; font-size: 1.1rem;">No trips yet</MudText>
            <MudText Color="Color.Default" Class="mb-4" Style="color:#27120F; font-size: 0.9rem;">You haven't saved any
                trips yet.
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Style="background-color: #743725;color:#EFE2D2; border-radius: 24px; padding: 10px 24px;"
                       StartIcon="@Icons.Material.Filled.Search"
                       Size="Size.Large"
                       FullWidth="false"
                       OnClick="GoToSearch">
                Find a Trip Now
            </MudButton>
        </MudPaper>
    }
    else
    {
        <MudStack Spacing="3" Style="margin-top: 5vh">
            @foreach (var trip in MySavedTrips.OrderByDescending(t => GetDepartureDate(t)))
            {
                bool isUnlocked = IsTripUnlocked(trip);

                @if (isUnlocked)
                {
                    <MudCard Elevation="3"
                             Class="trip-card-mobile"
                             Style="border-radius: 16px; overflow: hidden;"
                             @onclick="@(() => ShowTripDetails(trip))">
                        <MudCardHeader Style="background: #2F3630;color: #ffffff; padding: 12px 16px;">
                            <CardHeaderContent>
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <div>
                                        <MudText Typo="Typo.h6"
                                                 Style="color:#EFE2D2; font-size: 1.1rem; margin-bottom: 4px;">
                                            @trip.Destination
                                        </MudText>
                                    </div>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent Style="background-color: #CFCBC4; color: #27120F; padding: 16px;">
                            <MudStack Spacing="2">
                                <div class="d-flex align-start">
                                    <MudIcon Icon="@Icons.Material.Filled.FlightTakeoff"
                                             Size="Size.Small"
                                             Style="color: #743725; margin-right: 8px; margin-top: 2px;"/>
                                    <div style="flex: 1;">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.7; font-size: 0.7rem;">FLIGHT
                                        </MudText>
                                        <MudText Typo="Typo.body2" Style="font-size: 0.9rem; line-height: 1.3;">
                                            @GetCompactFlightInfo(trip)
                                        </MudText>
                                    </div>
                                </div>

                                <div class="d-flex align-start">
                                    <MudIcon Icon="@Icons.Material.Filled.Hotel"
                                             Size="Size.Small"
                                             Style="color: #743725; margin-right: 8px; margin-top: 2px;"/>
                                    <div style="flex: 1;">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.7; font-size: 0.7rem;">HOTEL
                                        </MudText>
                                        <MudText Typo="Typo.body2" Style="font-size: 0.9rem; line-height: 1.3;">
                                            @GetCompactHotelInfo(trip)
                                        </MudText>
                                    </div>
                                </div>

                                <MudDivider Class="my-2" Style="opacity: 0.3;"/>

                                <div class="d-flex justify-space-between align-center"
                                     style="background-color: rgba(116, 55, 37, 0.08); padding: 12px; border-radius: 8px; margin-top: 4px;">
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">Total Price</MudText>
                                    <MudText Typo="Typo.h6" Style="color: #743725; font-weight: 600;">
                                        â‚¬@trip.TotalPrice</MudText>
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
                else
                {
                    <MudCard Elevation="3"
                             Style="border-radius: 16px; overflow: hidden;">
                        <MudCardHeader Style="background-color: #3e2b26; color: #ffffff; padding: 12px 16px;">
                            <CardHeaderContent>
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <div>
                                        <MudText Typo="Typo.h6"
                                                 Style="color:#EFE2D2; font-size: 1.1rem; font-style: italic;">
                                            Surprise Awaits
                                        </MudText>
                                    </div>
                                    <MudIcon Icon="@Icons.Material.Filled.CardGiftcard"
                                             Style="color: #ffffff; font-size: 28px;"/>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>

                        <MudCardContent
                            Style="background-color: #CFCBC4; color: #27120F; padding: 24px 16px; text-align: center;">

                            <div
                                style="background-color: rgba(116, 55, 37, 0.1); padding: 12px; border-radius: 12px; margin: 12px 0;">
                                <MudText Typo="Typo.caption" Align="Align.Center"
                                         Style="opacity: 0.7; font-size: 0.7rem;">
                                    UNLOCKS IN
                                </MudText>
                                <MudText Typo="Typo.h6" Align="Align.Center"
                                         Style="color: #743725; font-weight: 600; font-size: 1.3rem;">
                                    @GetTimeUntilUnlock(trip)
                                </MudText>
                                <MudText Typo="Typo.caption" Align="Align.Center"
                                         Style="opacity: 0.6; font-size: 0.7rem; margin-top: 4px;">
                                    @GetUnlockDate(trip).ToString("MMM dd, HH:mm")
                                </MudText>
                            </div>
                        </MudCardContent>
                    </MudCard>
                }
            }
        </MudStack>
    }
</MudContainer>

@code {
    private List<TripOption>? MySavedTrips;
    private bool isLoading = true;
    private string? loadError = null;
    private Timer? refreshTimer;
    private TripOption? selectedTrip = null;
    private bool showDetailsDialog = false;
    private bool showLockDialog = false;

    private bool IsTripUnlocked(TripOption trip)
    {
        var departureDate = GetDepartureDate(trip);
        if (departureDate == DateTime.MaxValue) return false;

        var hoursUntilDeparture = (departureDate - DateTime.Now).TotalHours;
        return hoursUntilDeparture <= 24;
    }

    private DateTime GetDepartureDate(TripOption trip)
    {
        try
        {
            if (string.IsNullOrEmpty(trip.FlightInfo)) return DateTime.MaxValue;

            var parts = trip.FlightInfo.Split(" to ");
            if (parts.Length < 1) return DateTime.MaxValue;

            return DateTime.Parse(parts[0].Trim());
        }
        catch (Exception)
        {
            return DateTime.MaxValue;
        }
    }

    private DateTime GetUnlockDate(TripOption trip)
    {
        return GetDepartureDate(trip).AddHours(-24);
    }

    private string GetTimeUntilUnlock(TripOption trip)
    {
        var unlockDate = GetUnlockDate(trip);
        var timeSpan = unlockDate - DateTime.Now;

        if (timeSpan.TotalHours < 1)
            return "< 1 hour";
        else if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h";
        else if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d {timeSpan.Hours}h";
        else
            return $"{(int)timeSpan.TotalDays} days";
    }

    private string GetCompactFlightInfo(TripOption trip)
    {
        if (string.IsNullOrEmpty(trip.FlightInfo)) return "Flight details unavailable";

        if (trip.FlightInfo.Length > 50)
            return trip.FlightInfo.Substring(0, 47) + "...";

        return trip.FlightInfo;
    }

    private string GetCompactHotelInfo(TripOption trip)
    {
        if (string.IsNullOrEmpty(trip.HotelInfo)) return "Hotel details unavailable";

        if (trip.HotelInfo.Length > 50)
            return trip.HotelInfo.Substring(0, 47) + "...";

        return trip.HotelInfo;
    }

    private void ShowTripDetails(TripOption trip)
    {
        selectedTrip = trip;
        showDetailsDialog = true;
    }

    private void ShowLockExplanation()
    {
        showLockDialog = true;
    }

    private void RefreshTrips()
    {
        LoadTrips();
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        LoadTrips();

        refreshTimer = new Timer(_ => InvokeAsync(() => { StateHasChanged(); }), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void LoadTrips()
    {
        isLoading = true;
        loadError = null;

        if (UserSession.IsLoggedIn)
        {
            try
            {
                var repo = new TripRepository();
                MySavedTrips = repo.GetTripsByUser(UserSession.CurrentUserId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading trips: {ex.Message}");
                loadError = ex.Message;
                MySavedTrips = new List<TripOption>();
            }
        }

        isLoading = false;
    }

    private void RetryLoad()
    {
        LoadTrips();
        StateHasChanged();
    }

    private void GoToSearch()
    {
        NavManager.NavigateTo("flight-test");
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }

}