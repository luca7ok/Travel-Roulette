@page "/"
@inject NavigationManager NavManager
@inject NavMenuHide ok
@inject AuthService authService
@using System.Data
<PageTitle>Login</PageTitle>
<MudContainer Class="center-container">
<MudContainer MaxWidth="MaxWidth.ExtraSmall" >
    <MudCard Elevation="25" Class="pa-8">
        <MudCardHeader>
            <MudText Typo="Typo.h5" Class="mb-4">Welcome Back!</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudForm>

                @* Email Input Field *@
                <MudTextField T="string"
                              Label="Email Address" 
                              InputType="InputType.Email" 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Email" 
                              Required="true" 
                              Immediate="true"
                              Class="mb-4"
                              Disabled="@isLoading"
                              @bind-Value="emailInput"/>

                @* Password Input Field *@
                <MudTextField T="string"
                              Label="Password" 
                              InputType="InputType.Password" 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Lock" 
                              Required="true" 
                              Immediate="true"
                              Class="mb-6"
                              Disabled="@isLoading"
                              @bind-Value="passwordInput"/>

                @* Login Button *@
                <MudButton 
                    ButtonType="ButtonType.Button" 
                    Variant="Variant.Filled" 
                    Color="Color.Primary" 
                    Size="Size.Large" 
                    EndIcon="@(isLoading ? null : Icons.Material.Filled.Login)" 
                    FullWidth="true"
                    Disabled="@isLoading"
                    @onclick="HandleLogin">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Logging in...</MudText>
                    }
                    else
                    {
                        <span>LOG IN</span>
                    }
                </MudButton>
                
                <MudText Align="Align.Center" Class="mt-4">
                    <MudLink Href="/flight-test" Color="Color.Primary">
                        Still don't have an account?
                    </MudLink>
                </MudText>
            </MudForm>
        </MudCardContent>
    </MudCard>    
</MudContainer>
</MudContainer>
@code
{
    private string emailInput = string.Empty;
    private string passwordInput = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;
        isLoading = true;

        StateHasChanged();

        await Task.Run(() =>
        {
            var result = authService.LoginUser(emailInput, passwordInput, out DataRow? userData);

            InvokeAsync(() =>
            {
                if (result == AuthService.LoginResult.Success && userData != null)
                {
                    string userId = userData["id"].ToString();
                    ok.SetUserId(userId);

                    NavManager.NavigateTo("/flight-test");
                }
                else
                {
                    errorMessage = result switch
                    {
                        AuthService.LoginResult.UserNotFound => "Email not found. Please check your email address.",
                        AuthService.LoginResult.InvalidCredentials => "Invalid password. Please try again.",
                        AuthService.LoginResult.DatabaseError => "A service error occurred. Please try again later.",
                        _ => "An unknown error occurred."
                    };
                    Application.Current.MainPage.DisplayAlert("Login not succeded", "Wrong email/password", "OK");
                }

                isLoading = false;
                StateHasChanged();
            });
        });
    }
}