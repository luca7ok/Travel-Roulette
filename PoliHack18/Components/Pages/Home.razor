@page "/"
@inject NavigationManager NavManager
@inject NavMenuHide ok
@inject AuthService authService
@using System.Data

<PageTitle>Login</PageTitle>
<style>
    .login-wrapper {
        position: relative;
        min-height: 100vh;
        width: 100%;
        overflow: hidden;
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    .login-wrapper::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;

        background-image: url("images/map.png");
        background-repeat: repeat;
        background-size: 300px;

        transform: rotate(-45deg);
        opacity: 0.1;

        z-index: 0;
        pointer-events: none;
    }

    .content-layer {
        position: relative;
        z-index: 1;
        width: 100%;
    }
</style>
<MudContainer Class="center-container" Style="margin-top: 15vh;">
    <MudContainer MaxWidth="MaxWidth.ExtraSmall">
        <MudCard Elevation="25" Class="pa-8" Style="background-color:#cfcbc4; font-size: 18px">
            <MudCardHeader Style="text-align: center">
                <CardHeaderContent>
                    <MudText Typo="Typo.h4" Class="mb-4" Align="Align.Center">Login</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudForm>

                    <MudTextField T="string"
                                  Label="Email Address"
                                  InputType="InputType.Email"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                  Required="true"
                                  Immediate="true"
                                  Class="mb-4"
                                  Disabled="@isLoading"
                                  Style="color: black;"
                                  Margin="Margin.Dense"
                                  @bind-Value="emailInput"/>

                    <MudTextField T="string"
                                  Label="Password"
                                  InputType="InputType.Password"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Lock"
                                  Required="true"
                                  Immediate="true"
                                  Class="mb-6"
                                  Disabled="@isLoading"
                                  Style="color: black"
                                  Margin="Margin.Dense"
                                  @bind-Value="passwordInput"/>

                    <MudButton ButtonType="ButtonType.Button"
                               Variant="Variant.Filled"
                               Style="background-color:#9c8c69; color:#cfcbc4"
                               Size="Size.Large"
                               EndIcon="@(isLoading ? null : Icons.Material.Filled.Login)"
                               FullWidth="true"
                               Disabled="@isLoading"
                               @onclick="HandleLogin">
                        @if (isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                            <MudText Class="ms-2">Logging in...</MudText>
                        }
                        else
                        {
                            <span>LOG IN</span>
                        }
                    </MudButton>

                    <MudText Align="Align.Center" Class="mt-4">
                        <MudLink Href="/sign-up" Style="color:#9c8c69">
                            Still don't have an account?
                        </MudLink>
                    </MudText>
                </MudForm>
            </MudCardContent>
        </MudCard>
    </MudContainer>
</MudContainer>


@code
{
    private string emailInput = string.Empty;
    private string passwordInput = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;
        isLoading = true;

        StateHasChanged();

        await Task.Run(() =>
        {
            var result = authService.LoginUser(emailInput, passwordInput, out DataRow? userData);

            InvokeAsync(() =>
            {
                if (result == AuthService.LoginResult.Success && userData != null)
                {
                    string userId = userData["id"].ToString();
                    ok.SetUserId(userId);

                    NavManager.NavigateTo("/flight-test", replace: true);
                }
                else
                {
                    errorMessage = result switch
                    {
                        AuthService.LoginResult.UserNotFound => "Email not found. Please check your email address.",
                        AuthService.LoginResult.InvalidCredentials => "Invalid password. Please try again.",
                        AuthService.LoginResult.DatabaseError => "A service error occurred. Please try again later.",
                        _ => "An unknown error occurred."
                    };
                    Application.Current.MainPage.DisplayAlert("Login not succeded", "Wrong email/password", "OK");
                }

                isLoading = false;
                StateHasChanged();
            });
        });
    }
}